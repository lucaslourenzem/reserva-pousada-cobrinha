<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seja Bem‚ÄëVindo Pescador! ¬∑ Pousada do Cobrinha</title>
 
 
  <style>
    :root{--bg:#f7f2e7;--ink:#2d2a26;--accent:#1e6f5c;--accent-2:#b87333;--wood:#7a5230;--muted:#6a5f55;--error:#b00020;--ok:#1b5e20}
    html,body{background:var(--bg);color:var(--ink);font-family: ui-serif, Georgia, "Times New Roman", Times, serif}
    .wrap{max-width:820px;margin:32px auto;padding:24px} /* ‚Üì mais compacto e centralizado */
    .card{background:linear-gradient(180deg,#fff8ee,#f7efdf);border:2px solid var(--wood);box-shadow:0 6px 0 var(--wood),0 10px 20px rgba(0,0,0,.08);border-radius:18px;padding:24px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:16px;justify-content:center;text-align:center}
    header img{width:70px;height:70px;object-fit:contain;border-radius:50%;border:2px solid var(--accent-2);background:#fff}
    h1{font-size:clamp(22px,3.8vw,36px);margin:0;color:var(--wood);letter-spacing:.03em}
    .subtitle{color:var(--muted);margin-top:4px}

    /* grid centralizado, largura confort√°vel */
    form{
        display:grid;grid-template-columns:repeat(12,1fr);gap:14px;margin-top:14px;
        align-items:start;justify-items:stretch
    }
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-weight:700;color:var(--wood)}
    .field input,.field select,.field textarea{padding:10px 12px;border:2px solid var(--wood);border-radius:12px;background:#fff;font-size:15px;outline:none;transition:box-shadow .15s ease,border-color .15s ease}
    .field input:focus,.field select:focus,.field textarea:focus{box-shadow:0 0 0 4px rgba(184,115,51,.22);border-color:var(--accent-2)}
    .col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}.col-12{grid-column:1/-1}
    .hint{font-size:12px;color:var(--muted)}
    .pill{display:inline-block;padding:6px 10px;border:2px dashed var(--accent-2);border-radius:999px;color:var(--accent-2);background:#fff8f0;font-weight:700}
    .btns{display:flex;flex-wrap:wrap;gap:15px;align-items: center;flex-direction: column;margin-top:6px;justify-content:center}
    button{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:800;letter-spacing:.02em}
    .btn-primary{background:var(--accent);color:#fff}.btn-secondary{background:var(--accent-2);color:#fff}.btn-outline{background:#fff;border:2px solid var(--wood);color:var(--wood)}
    .notice{border-left:6px solid var(--accent-2);background:#fff7ef;padding:12px;border-radius:12px}
    .error{color:var(--error)}.ok{color:var(--ok)}
    .totals{background:#fff;border:2px solid var(--wood);border-radius:16px;padding:14px}
    .totals h3{margin-top:0;text-align:center}
    .totals dl{display:grid;grid-template-columns:1fr auto;gap:8px;font-variant-numeric:tabular-nums}
    .totals dt{color:var(--muted)}.totals dd{margin:0;font-weight:800}
    footer{margin-top:18px;color:var(--muted);font-size:12px;text-align:center}
    @media(max-width:780px){.col-6,.col-4,.col-3,.col-2{grid-column:1/-1}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <img src="logo.png" alt="Pousada do Cobrinha" />
        <div>
          <h1>Seja Bem‚ÄëVindo Pescador!</h1>
          <div class="subtitle">Preencha sua simula√ß√£o de reserva. Fa√ßa um or√ßamento e converse conosco!</div>
        </div>
      </header>

      <div class="notice">
        <span class="pill">UM DIA NA AREIA BRANCA</span> 
      </div>

      <form id="bookingForm">
        <div class="field col-6">
          <label for="nome">Nome</label>
          <input id="nome" name="nome" type="text" required minlength="3" placeholder="Seu nome completo" />
        </div>
        <div class="field col-6">
          <label for="contato">Forma de Contato</label>
          <select id="contato" name="contato" required>
            <option value="WhatsApp">WhatsApp</option>
            <option value="Email">E-mail</option>
          </select>
        </div>

        <div class="field col-6">
          <label for="email">E‚Äëmail</label>
          <input id="email" name="email" type="email" placeholder="ex: lucas@example.com" />
          <span class="hint">Obrigat√≥rio se a forma de contato for E-mail.</span>
        </div>
        <div class="field col-6">
          <label for="telefone">Telefone</label>
          <input id="telefone" name="telefone" type="tel" placeholder="(xx) xxxxx-xxxx" pattern="^\(?\d{2}\)?\s?\d{4,5}-?\d{4}$" />
          <span class="hint">Obrigat√≥rio se a forma de contato for WhatsApp.</span>
        </div>

        <div class="field col-4">
          <label for="check_in">Check‚Äëin</label>
          <input id="check_in" name="check_in" type="date" required />
        </div>
        <div class="field col-4">
          <label for="check_out">Check‚Äëout</label>
          <input id="check_out" name="check_out" type="date" required />
        </div>
        <div class="field col-2">
          <label for="hrs_checkin">Chegada</label>
          <input id="hrs_checkin" name="hrs_checkin" type="time" />
          <span class="hint">Check-in a partir das 14:00 horas.</span>
        </div>
        <div class="field col-2">
          <label for="hrs_checkout">Sa√≠da</label>
          <input id="hrs_checkout" name="hrs_checkout" type="time" />
          <span class="hint">Check-out at√© as 10:00 horas.</span>
        </div>

        <div class="field col-4">
          <label for="estadia">Tipo de Estadia</label>
          <select id="estadia" name="estadia" required>
            <option value="Quarto">Quarto</option>
            <option value="Camping">Camping</option>
          </select>
        </div>
        <div class="field col-2">
          <label for="adultos">Adultos</label>
          <input id="adultos" name="adultos" type="number" min="1" max="40" value="4" required />
        </div>
        <div class="field col-2">
          <label for="criancas">Crian√ßas</label>
          <input id="criancas" name="criancas" type="number" min="0" max="40" value="2" />
          <span class="hint">6 at√© 11 anos.</span>
        </div>

        <div class="field col-4">
          <label for="plano_refeicao">Plano de Refei√ß√£o</label>
          <select id="plano_refeicao" name="plano_refeicao" required>
            <option value="Cafe">Caf√©</option>
            <option value="Cafe_Almoco">Caf√© e Almo√ßo</option>
            <option value="Completo" selected>Completo</option>
          </select>
        </div>
        <div class="field col-4">
          <label for="dias_pesca">Dias de Pesca</label>
          <input id="dias_pesca" name="dias_pesca" type="number" min="0" max="30" value="0" />
        </div>
        <div class="field col-4">
          <label for="barcos">N¬∫ de barcos</label>
          <input id="barcos" name="barcos" type="number" min="0" max="10" value="0" />
        </div>

        <div class="col-12 notice"><b>Acomoda√ß√£o</b> Com base no total de pessoas e na disponibilidade:Entre 1 Casa (com 2 Su√≠tes), 2 Apartamentos e 3 Su√≠tes (capacidade sugerida: at√© 28 pessoas). Grupos maiores ‚Üí entre em contato conosco.</div>
        <div class="col-12 btns">
            <button class="btn-primary" type="button" id="btnQuote">Calcular Or√ßamento</button>
        </div>
        <div id="availabilityMsg" class="hint" style="margin-top:6px"></div>

        <div class="col-12 totals" id="totalsBox" hidden>
          <h3>Resumo do Or√ßamento</h3>
          <dl>
            <dt>Noites</dt><dd id="t_noites">0</dd>
            <dt>Pessoas (aloca√ß√£o)</dt><dd id="t_pessoas">0</dd>
            <dt>Base di√°ria</dt><dd id="t_diaria">R$ 0,00</dd>
            <dt>Subtotal hospedagem</dt><dd id="t_subtotal">R$ 0,00</dd>
            <dt>Pescaria (barcos√ódias)</dt><dd id="t_pescaria">R$ 0,00</dd>
            <dt><b>Total estimado</b></dt><dd id="t_total"><b>R$ 0,00</b></dd>
          </dl>
          <div class="hint">* Em <b>Quarto</b>, crian√ßas contam como 0,5 no <em>valor</em>. Em <b>Camping</b>, contam como 1.</div>
        </div>

        <div class="col-12 btns">
          <button class="btn-primary" type="submit">Enviar Reserva</button>
          <span class="hint"><b>Confirma√ß√£o ap√≥s dep√≥sito de 50%.</b></span>
        </div>
      </form>

      <footer>¬© <span id="year"></span> Pousada do Cobrinha ¬∑ Layout do pescador üé£</footer>
    </div>
  </div>
 
  <script>
    // ======================
    // CONFIGURA√á√ÉO n8n
    // ======================
    const WEBHOOK_URL     = "https://n8n.srv1028851.hstgr.cloud/webhook-test/make-booking";
    const CHECK_AVAIL_URL = "https://n8n.srv1028851.hstgr.cloud/webhook/make-booking";

    // ======================
    // UTILIT√ÅRIOS
    // ======================
    const $$  = sel => document.querySelector(sel);
    const fmt = v  => v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    const todayISO = () => new Date().toISOString().slice(0,10);
    const addDays  = (d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x.toISOString().slice(0,10)};

    // refs de campos
    const el = {
      contato:     null,
      email:       null,
      telefone:    null,
      estadia:     null,
      plano:       null,
      dias_pesca:  null,
      barcos:      null,
      adultos:     null,
      criancas:    null,
      check_in:    null,
      check_out:   null,
      totalsBox:   null,
    };

    // debounce para pr√©-checagem
    let preblockTimer;
    function schedulePreblock(){
      clearTimeout(preblockTimer);
      preblockTimer = setTimeout(preblockCalendar, 300);
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      // bind
      el.contato    = $$('#contato');
      el.email      = $$('#email');
      el.telefone   = $$('#telefone');
      el.estadia    = $$('#estadia');
      el.plano      = $$('#plano_refeicao');
      el.dias_pesca = $$('#dias_pesca');
      el.barcos     = $$('#barcos');
      el.adultos    = $$('#adultos');
      el.criancas   = $$('#criancas');
      el.check_in   = $$('#check_in');
      el.check_out  = $$('#check_out');
      el.totalsBox  = $$('#totalsBox');

      // defaults
      el.check_in.value  = addDays(todayISO(), 10);
      el.check_out.value = addDays(todayISO(), 14);
      $$('#email').value = 'lucas@example.com';
      document.getElementById('year').textContent = new Date().getFullYear();

      // limites de data + v√≠nculo de min
      el.check_in.min = todayISO();
      el.check_out.min = el.check_in.value;
      el.check_in.addEventListener('change', ()=>{
        el.check_out.min = el.check_in.value;
        schedulePreblock();
      });

      // visibilidade e required din√¢micos
      applyVisibilityRules();
      applyContatoRequired();

      [el.estadia, el.dias_pesca].forEach(n=>n.addEventListener('change', applyVisibilityRules));
      [el.adultos, el.criancas, el.check_in, el.check_out, el.estadia].forEach(n=>n.addEventListener('change', schedulePreblock));
      [el.check_out].forEach(n=>n.addEventListener('change', schedulePreblock));
      el.contato.addEventListener('change', applyContatoRequired);

      // Bot√£o or√ßamento
      document.getElementById('btnQuote').addEventListener('click', ()=>{
        try{ showTotals(calcQuote()); } catch(e){ alert(e.message); }
      });

      // Submit
      document.getElementById('bookingForm').addEventListener('submit', onSubmit);
    });

    // regras de exibi√ß√£o (plano s√≥ em Quarto; barcos s√≥ se dias_pesca>0)
    function applyVisibilityRules(){
      const isQuarto = el.estadia.value === 'Quarto';
      const pescaOn  = Number(el.dias_pesca.value||0) > 0;
      toggleField('#plano_refeicao', isQuarto);
      toggleField('#barcos', pescaOn);
    }

    // required din√¢mico conforme Forma de Contato
    function applyContatoRequired(){
      const byEmail = el.contato.value === 'Email';
      const byZap   = el.contato.value === 'WhatsApp';
      // email required se contato = Email
      el.email.toggleAttribute('required', byEmail);
      // telefone required se contato = WhatsApp
      el.telefone.toggleAttribute('required', byZap);
    }

    // mostra/oculta + preserva/limpa required corretamente
    function toggleField(selector, show){
      const field = document.querySelector(selector)?.closest('.field');
      if(!field) return;
      const inputs = field.querySelectorAll('input,select,textarea');

      if(show){
        field.style.display = '';
        inputs.forEach(inp=>{
          if(inp.dataset.wasRequired === '1'){
            inp.setAttribute('required','required');
          }
        });
      } else {
        field.style.display = 'none';
        inputs.forEach(inp=>{
          // guarda e remove required
          inp.dataset.wasRequired = inp.hasAttribute('required') ? '1' : '';
          inp.removeAttribute('required');
          // limpa valor
          if(inp.tagName==='SELECT') inp.selectedIndex = 0;
          else inp.value = (inp.type==='number' ? 0 : '');
        });
      }
    }

    function nights(ci, co){
      const a = new Date(ci); const b = new Date(co);
      const diff = Math.round((b - a) / (1000*60*60*24));
      // mesmo dia = 2 di√°rias
      return diff <= 0 ? 2 : diff;
    }

    function sameDay(ci, co){
      const a = new Date(ci); const b = new Date(co);
      return a.toDateString() === b.toDateString();
    }

    function peopleAllocation(adultos, criancas){
      return Number(adultos||0) + Number(criancas||0);
    }
    function peopleBilling(adultos, criancas, estadia){
      if(estadia === 'Camping') return Number(adultos||0) + Number(criancas||0);
      return Number(adultos||0) + 0.5*Number(criancas||0);
    }
    function baseRate(estadia, plano){
      if(estadia === 'Camping') return 80;
      const map = { 'Cafe':250, 'Cafe_Almoco':300, 'Completo':350 };
      return map[plano] ?? 250;
    }

    // Pr√©-bloqueio de calend√°rio (consulta leve ao back)
    async function preblockCalendar(){
      try{
        const payload = collectForm({looseDates:true});
        const total = peopleAllocation(payload.adultos, payload.criancas);

        if(payload.estadia==='Camping' && total>25){
          const msg = 'Camping comporta at√© 25 pessoas. Ajuste o grupo.';
          el.check_in.setCustomValidity(msg);
          el.check_in.reportValidity();
          return;
        }

        const res = await fetch(CHECK_AVAIL_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json','Cache-Control':'no-store'},
          body: JSON.stringify(payload),
          cache: 'no-store'
        });

        if(res.status === 409){
          const msg = 'Per√≠odo indispon√≠vel para a quantidade de pessoas selecionada.';
          el.check_in.setCustomValidity(msg);
          el.check_out.setCustomValidity(msg);
          el.check_in.reportValidity();
        } else {
          el.check_in.setCustomValidity('');
          el.check_out.setCustomValidity('');
        }
      }catch{
        el.check_in.setCustomValidity('');
        el.check_out.setCustomValidity('');
      }
    }

    function generateReqId(){
      const b = new Uint8Array(16);
      crypto.getRandomValues(b);
      b[6] = (b[6] & 0x0f) | 0x40; // version
      b[8] = (b[8] & 0x3f) | 0x80; // variant
      const hex = [...b].map(x=>x.toString(16).padStart(2,'0'));
      return `${hex.slice(0,4).join('')}-${hex.slice(4,6).join('')}-${hex.slice(6,8).join('')}-${hex.slice(8,10).join('')}-${hex.slice(10,16).join('')}`;
    }

    function calcQuote(){
      const ci = el.check_in.value; const co = el.check_out.value;
      if(!ci || !co) throw new Error('Informe Check-in e Check-out.');
      const n = nights(ci,co);

      const adultos = Number(el.adultos.value||0);
      const criancas = Number(el.criancas.value||0);
      const estadia = el.estadia.value;
      const plano   = (estadia==='Quarto') ? el.plano.value : 'Cafe'; // fallback

      // regras locais
      if(criancas >= adultos) throw new Error('O n√∫mero de crian√ßas deve ser menor que o de adultos.');
      if(estadia==='Camping' && (adultos+criancas) > 25) throw new Error('Camping comporta at√© 25 pessoas.');

      const ppBill  = peopleBilling(adultos, criancas, estadia);
      const diaria  = baseRate(estadia, plano);
      let subtotal  = diaria * ppBill * n;

      // mesmo dia (2 di√°rias) ‚Üí desconto na "segunda di√°ria"
      let desconto_segunda = 0;
      if(sameDay(ci,co)){            // n === 2
        if(plano === 'Completo')       desconto_segunda = 100;
        else if(plano === 'Cafe_Almoco') desconto_segunda = 50;
        else desconto_segunda = 0;
        subtotal -= desconto_segunda;
      }

      const pesca = 450 * Number(el.dias_pesca.value||0) * Number(el.barcos.value||0);
      const total = subtotal + pesca;
      return { noites:n, pessoas:adultos+criancas, diaria, subtotal, pesca, total, desconto_segunda, mesmo_dia:sameDay(ci,co) };
    }

    function showTotals(t){
      $$('#t_noites').textContent   = t.noites;
      $$('#t_pessoas').textContent  = t.pessoas;
      $$('#t_diaria').textContent   = fmt(t.diaria);
      $$('#t_subtotal').textContent = fmt(t.subtotal);
      $$('#t_pescaria').textContent = fmt(t.pesca);
      $$('#t_total').textContent    = fmt(t.total);
      el.totalsBox.hidden = false;
    }

    // Se looseDates=true, evita explodir por ordem das datas durante digita√ß√£o
    function collectForm({looseDates=false}={}){
      const f = document.getElementById('bookingForm');
      const o = Object.fromEntries(new FormData(f).entries());
      ['adultos','criancas','dias_pesca','barcos'].forEach(k=>o[k]=Number(o[k]||0));

      if(o.contato==='Email' && !o.email)       throw new Error('E-mail √© obrigat√≥rio quando a forma de contato √© E-mail.');
      if(o.contato==='WhatsApp' && !o.telefone) throw new Error('Telefone √© obrigat√≥rio quando a forma de contato √© WhatsApp.');

      if(!looseDates){
        if(new Date(o.check_out) < new Date(o.check_in)){ // mesmo dia permitido (vira 2 di√°rias)
          throw new Error('Check-out n√£o pode ser antes do Check-in.');
        }
        if(o.criancas >= o.adultos) throw new Error('O n√∫mero de crian√ßas deve ser menor que o de adultos.');
      }

      o.status = 'Nao';
      return o; // backend decide aloca√ß√£o
    }

    async function onSubmit(e){
      e.preventDefault();
      try{
        const payload = collectForm();
        const quote   = calcQuote();
        const body    = { ...payload, valor_estimado: quote.total, noites: quote.noites, req_id: generateReqId() };

        const res = await fetch(WEBHOOK_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(body)
        });

        if(res.status === 409){
          const proceed = confirm('Est√° cheio para o per√≠odo selecionado. Deseja continuar mesmo assim?');
          if(!proceed) return;
        }

        const data = await res.json().catch(()=>({}));
        if(res.ok){
          alert('Reserva enviada com sucesso!\nProtocolo: ' + (data.reserva_id || '‚Äî'));
        } else {
          alert('Falha ao enviar: ' + (data.error || res.statusText));
        }
      }catch(err){
        alert(err.message);
      }
    }
  </script>
</body>
</html>